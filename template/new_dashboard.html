<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sensor Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      background-color: #f0f2f5;
    }

    .sidebar {
      width: 250px;
      background-color: #2c3e50;
      color: #ecf0f1;
      height: 100vh;
      position: fixed;
      overflow-y: auto;
    }

    .sidebar h2 {
      padding: 20px;
      margin: 0;
      background-color: #1abc9c;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      padding: 15px 20px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .sidebar ul li:hover {
      background-color: #34495e;
    }

    .nested {
      display: none;
      background-color: #3d566e;
    }

    .nested li {
      padding-left: 30px;
    }

    .active {
      display: block;
    }

    .main-content {
      margin-left: 260px;
      padding: 20px; /* Added top padding */
      flex-grow: 1;
      width: calc(100% - 260px);
    }

    .card-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    .card {
      background-color: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      text-align: left;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      height: 460px;
      justify-content: space-between;
    }
    
    .card canvas {
      width: 100% !important;
      height: 400px !important;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .card h3 {
      margin: 5px 0 8px;
      font-size: 16px;
      color: #2c3e50;
    }
    
    .card .info-line {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #555;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    .card p {
      margin: 5px 0;
      font-size: 14px;
      color: #555;
    }

    .city-title {
      margin: 30px 0 10px;
      font-size: 20px;
      font-weight: bold;
    }

    .city-Delhi { color: #3498db; }
    .city-Mumbai { color: #27ae60; }
    .city-Hyderabad { color: #f39c12; }
    .city-Pune { color: #e74c3c; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background-color: #1abc9c;
      color: white;
    }

    input {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: 5px;
    }
    .settings-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .settings-container .card {
      flex: 1 1 300px;
      max-width: 400px;
    }
    .settings-container .card input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin-top: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .chart-container {
      height: 300px; /* or 400px as needed */
    }

    .header {
      position: fixed;
      top: 0;
      right: 0;
      height: 60px;
      background: #fff;
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .header img {
      height: 40px;
      object-fit: contain;
    }
    .home-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .home-header h2 {
      margin: 0;
      font-size: 24px;
      color: #2c3e50;
    }

    .home-logo {
      height: 50px;
      object-fit: contain;
    }
    canvas {
      max-width: 100%;
      margin-bottom: 40px;
    }

    canvas#statusChart {
      max-width: 400px;
      margin: 0 auto;
      display: block;
    }
    .card-container .chart-wrapper {
      height: 400px !important;
    }

    .card-container .chart-wrapper canvas {
      height: 100% !important;
      width: 100% !important;
    }


  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add this to your HTML HEAD if not already present -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>


</head>
<body>


  <div class="sidebar">
    <h2>Dashboard</h2>
    <ul>
      <li onclick="loadHome()">Home</li>
      <li onclick="toggleNested('cities')">Cities</li>
      <ul id="cities" class="nested">
        <li onclick="toggleNested('delhi')">Delhi</li>
        <ul id="delhi" class="nested">
          <li onclick="selectSensor('Delhi', 'Sensor 1')">Sensor 1</li>
          <li onclick="selectSensor('Delhi', 'Sensor 2')">Sensor 2</li>
          <li onclick="selectSensor('Delhi', 'Sensor 3')">Sensor 3</li>
          <li onclick="selectSensor('Delhi', 'Sensor 4')">Sensor 4</li>
        </ul>
        <li onclick="toggleNested('mumbai')">Mumbai</li>
        <ul id="mumbai" class="nested">
          <li onclick="selectSensor('Mumbai', 'Sensor 1')">Sensor 1</li>
          <li onclick="selectSensor('Mumbai', 'Sensor 2')">Sensor 2</li>
          <li onclick="selectSensor('Mumbai', 'Sensor 3')">Sensor 3</li>
          <li onclick="selectSensor('Mumbai', 'Sensor 4')">Sensor 4</li>
        </ul>
        <li onclick="toggleNested('hyderabad')">Hyderabad</li>
        <ul id="hyderabad" class="nested">
          <li onclick="selectSensor('Hyderabad', 'Sensor 1')">Sensor 1</li>
          <li onclick="selectSensor('Hyderabad', 'Sensor 2')">Sensor 2</li>
          <li onclick="selectSensor('Hyderabad', 'Sensor 3')">Sensor 3</li>
          <li onclick="selectSensor('Hyderabad', 'Sensor 4')">Sensor 4</li>
        </ul>
        <li onclick="toggleNested('pune')">Pune</li>
        <ul id="pune" class="nested">
          <li onclick="selectSensor('Pune', 'Sensor 1')">Sensor 1</li>
          <li onclick="selectSensor('Pune', 'Sensor 2')">Sensor 2</li>
          <li onclick="selectSensor('Pune', 'Sensor 3')">Sensor 3</li>
          <li onclick="selectSensor('Pune', 'Sensor 4')">Sensor 4</li>
        </ul>
      </ul>
      <li onclick="loadSettings()">Settings</li>
      <li onclick="toggleNested('analytics')">Analytics</li>
       <ul id="analytics" class="nested">
        <li onclick="loadUserEngagementChart()">User Engagement</li>
        <li onclick="loadDemographicOverviewChart()">Demographic Overview</li>
       </ul>

    </ul>
  </div>

  <div class="main-content" id="main-content"></div>

  <script>
    const API_URL = "http://3.108.220.219:5000/samvaad-ui/get_sensor_readings";
    let currentSensor = null;
    let socket = null;
    let chart = null;
    let chartData = {
      labels: [],
      datasets: [{
        label: 'Sensor Reading',
        data: [],
        fill: false,
        borderColor: 'blue',
        tension: 0.1
      }]
    };
    const data = {
      "Delhi": {
        "Sensor 1": { status: "On", readings: [20, 21, 22, 23, 24] },
        "Sensor 2": { status: "Off", readings: [10, 12, 14, 15, 13] },
        "Sensor 3": { status: "On", readings: [30, 31, 29, 28, 32] },
        "Sensor 4": { status: "Off", readings: [5, 6, 7, 8, 9] },
      },
      "Mumbai": {
        "Sensor 1": { status: "On", readings: [22, 23, 24, 25, 26] },
        "Sensor 2": { status: "Off", readings: [18, 19, 20, 21, 22] },
        "Sensor 3": { status: "On", readings: [12, 13, 14, 15, 16] },
        "Sensor 4": { status: "On", readings: [1, 2, 3, 4, 5] },
      },
      "Hyderabad": {
        "Sensor 1": { status: "Off", readings: [33, 34, 35, 36, 37] },
        "Sensor 2": { status: "On", readings: [17, 18, 19, 20, 21] },
        "Sensor 3": { status: "Off", readings: [7, 8, 9, 10, 11] },
        "Sensor 4": { status: "On", readings: [44, 45, 46, 47, 48] },
      },
      "Pune": {
        "Sensor 1": { status: "On", readings: [60, 61, 62, 63, 64] },
        "Sensor 2": { status: "On", readings: [71, 72, 73, 74, 75] },
        "Sensor 3": { status: "Off", readings: [82, 83, 84, 85, 86] },
        "Sensor 4": { status: "Off", readings: [93, 94, 95, 96, 97] },
      },
    };
    const sensorReadingsLive = {}; // { sensor1: [...], sensor2: [...], ... }
    const liveSensorData = {};
    let socketConnected = true;
    // let sensorCharts = {};
    // Extract sensor data arrays and timestamps
    // const sensorReadings = {
    //   sensor1: [],
    //   sensor2: [],
    //   sensor3: [],
    //   sensor4: [],
    //   times: []
    // };
    function toggleNested(id) {
      const elem = document.getElementById(id);
      if (elem) elem.classList.toggle("active");
    }
    function formatCustomTime(input) {
  if (!input || typeof input !== "string" || !input.includes(" ")) {
    return "Invalid Time";
  }

  const [datePart, timePart] = input.split(" ");
  if (!datePart || !timePart) return "Invalid Time";

  const [day, month, year] = datePart.split("/").map(Number);
  const [hour, minute] = timePart.split(":").map(Number);
  if (isNaN(day) || isNaN(month) || isNaN(year) || isNaN(hour) || isNaN(minute)) {
    return "Invalid Time";
  }

  const date = new Date(year, month - 1, day, hour, minute);
  return `${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
}

async function loadHome() {
  const container = document.getElementById("main-content");
  container.innerHTML = `
    <div class="home-header">
      <h2>All Sensor Readings</h2>
      <img src="logo_4_NW.png" alt="Company Logo" class="home-logo" />
    </div>
    <div class="card-container" id="card-container"></div>
  `;

  const chartContainer = document.getElementById("card-container");

  // Sensor list
  const sensors = ["sensor1", "sensor2", "sensor3", "sensor4"];

  sensors.forEach(sensor => {
    const chartId = `chart-${sensor}`;
    const expandId = `${sensor}-expand`;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
        <h3 style="margin: 0;">${sensor.toUpperCase()}</h3>
        <span id="${sensor}-status-card" class="status-icon">‚ùå</span>
      </div>
      <div class="info-line">Current: <strong id="${sensor}-latest-val">-</strong></div>
      <div class="chart-wrapper" style="height: 300px;">
        <canvas id="${chartId}" style="height: 100%; width: 100%;"></canvas>
      </div>
      <!-- Expandable Section -->
      <div id="${expandId}" class="expandable" style="display: none; margin-top:10px; padding:10px; border-top:1px solid #ddd; background:#fafafa;">
        <h4>All Sensor Details</h4>
        <ul style="margin:0; padding-left:16px;">
          ${sensors.map(s => `<li>${s.toUpperCase()} - <span id="${s}-val">--</span></li>`).join("")}
        </ul>
      </div>
    `;
    chartContainer.appendChild(card);

    // Toggle expand/collapse
    card.querySelector(".card-header").addEventListener("click", () => {
      const expandDiv = document.getElementById(expandId);
      expandDiv.style.display = expandDiv.style.display === "none" ? "block" : "none";
    });
  });

  // Example fake sensor data
  const fakeSensors = [
    { id: "temperature", label: "Temperature (¬∞C)", data: [24, 25, 26, 25, 24, 25] },
    { id: "humidity", label: "Humidity (%)", data: [55, 56, 58, 57, 55, 54] }
  ];

  fakeSensors.forEach(sensor => {
    const chartId = `chart-${sensor.id}`;
    const expandId = `${sensor.id}-expand`;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; cursor:pointer;">
        <h3 style="margin: 0;">${sensor.label}</h3>
        <span id="${sensor.id}-status" class="status-icon">‚úÖ</span>
      </div>
      <div class="chart-wrapper" style="height: 300px;">
        <canvas id="${chartId}" style="height: 100%; width: 100%;"></canvas>
      </div>
      <!-- Expandable -->
      <div id="${expandId}" class="expandable" style="display: none; margin-top:10px; padding:10px; border-top:1px solid #ddd; background:#fafafa;">
        <h4>All Sensor Details</h4>
        <ul style="margin:0; padding-left:16px;">
          ${fakeSensors.map(s => `<li>${s.label} - <span id="${s.id}-val">--</span></li>`).join("")}
        </ul>
      </div>
    `;
    chartContainer.appendChild(card);

    // Toggle expand
    card.querySelector(".card-header").addEventListener("click", () => {
      const expandDiv = document.getElementById(expandId);
      expandDiv.style.display = expandDiv.style.display === "none" ? "block" : "none";
    });

    // ChartJS
    const ctx = document.getElementById(chartId).getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: ["T-5", "T-4", "T-3", "T-2", "T-1", "Now"],
        datasets: [{
          data: sensor.data,
          borderColor: "#f39c12",
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "Time" } },
          y: { beginAtZero: true }
        }
      }
    });
  });

  startSocketLiveUpdates();
}

const sensorReadings = { sensor1: [], sensor2: [], sensor3: [], sensor4: [], times: [] };
const sensorCharts = {};

function startSocketLiveUpdates() {
  const socket = io("http://3.108.220.219:5000", { transports: ["websocket"] });

  socket.on("connect", () => {
    console.log("‚úÖ Connected to Socket.IO server");
    socketConnected = true;
  });

  socket.on("new_reading", (data) => {

    const timeLabel = formatCustomTime(data.reading_time); // ‚Üí "HH:mm" string

    sensorReadings.times.push(timeLabel);
    if (sensorReadings.times.length > 20) sensorReadings.times.shift();

    ["sensor1", "sensor2", "sensor3", "sensor4"].forEach(sensor => {
      const value = data[sensor];

    if (value === undefined) return;

    // if (!sensorReadingsLive[sensor]) {
    //   sensorReadingsLive[sensor] = [];
    // }

    // // Store trimmed data
    // sensorReadingsLive[sensor].push({
    //   reading_time: timeLabel,
    //   [sensor]: value
    // });

    // // Keep only last 10
    // if (sensorReadingsLive[sensor].length > 10) {
    //   sensorReadingsLive[sensor].shift();
    // }

    // // Debug
    // console.log(`üìä ${sensor}:`, sensorReadingsLive[sensor]);

    // // Update UI only if this sensor is selected
    // if (sensor === currentSensor) {
    //   displaySensorData(sensor);
    // }
      if (!sensorReadingsLive[sensor]) {
      sensorReadingsLive[sensor] = [];
    }

    // Store only time and value for this sensor
    sensorReadingsLive[sensor].push({
      reading_time: timeLabel,
      [sensor]: data[sensor]
    });

    // Keep only last 10 readings
    if (sensorReadingsLive[sensor].length > 10) {
      sensorReadingsLive[sensor].shift();
    }

    // Only update chart if user is viewing this sensor
    if (sensor === currentSensor) {
      displaySensorData(sensor);
    }
      const isConnected = socketConnected && value !== null && value !== undefined;

      sensorReadings[sensor].push(value);
      if (sensorReadings[sensor].length > 20) sensorReadings[sensor].shift();

      document.getElementById(`${sensor}-latest-val`).textContent = value;
      const tableVal = document.getElementById(`${sensor}-latest`);
      if (tableVal) tableVal.textContent = value;

      // Update card status icon
      const statusCard = document.getElementById(`${sensor}-status-card`);
      if (statusCard) {
        statusCard.textContent = isConnected ? "‚úÖ" : "‚ùå";
        statusCard.style.color = isConnected ? "green" : "red";
        statusCard.title = isConnected ? "Connected" : "Disconnected";
      }

      // Update table status icon
      const statusTable = document.getElementById(`${sensor}-status-table`);
      if (statusTable) {
        statusTable.textContent = isConnected ? "‚úÖ" : "‚ùå";
        statusTable.style.color = isConnected ? "green" : "red";
        statusTable.title = isConnected ? "Connected" : "Disconnected";
      }

      const ctx = document.getElementById(`chart-${sensor}`)?.getContext("2d");
      if (!ctx) return;

      if (!sensorCharts[sensor]) {
        sensorCharts[sensor] = new Chart(ctx, {
          type: "line",
          data: {
            labels: sensorReadings.times,
            datasets: [{
              data: sensorReadings[sensor],
              borderColor: "#1abc9c",
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: 0
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  callback: function (value, index, ticks) {
                    return sensorReadings.times[value] || "";
                  },
                  autoSkip: true,
                  maxTicksLimit: 6
                },
                title: { display: true, text: "Time" }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 5
                }
               }

            }
          }
        });
      } else {
        const chart = sensorCharts[sensor];
        chart.data.labels = sensorReadings.times;
        chart.data.datasets[0].data = sensorReadings[sensor];
        chart.update();
      }
    });
  });

  socket.on("disconnect", () => {
    console.warn("üîå Disconnected from server");
    socketConnected = false;

  });
  // Interval to watch and update sensor status
setInterval(() => {
  if (!socketConnected) {
    ["sensor1", "sensor2", "sensor3", "sensor4"].forEach(sensor => {
      const card = document.getElementById(`${sensor}-status-card`);
      const table = document.getElementById(`${sensor}-status-table`);
      [card, table].forEach(el => {
        if (el) {
          el.textContent = "‚ùå";
          el.style.color = "red";
          el.title = "Disconnected";
        }
      });
    });
  }
}, 1000); // Runs every second
} 
    function selectSensor(city, sensorName) {
  // Convert "Sensor 1" to "sensor1"
  const sensorKey = sensorName.toLowerCase().replace(" ", "");
  currentSensor = sensorKey;

  const container = document.getElementById("main-content");
  container.innerHTML = `
    <div class="home-header">
      <h2>${city} - ${sensorName}</h2>
      <img src="logo_4_NW.png" alt="Logo" class="home-logo" />
    </div>
    <div class="card">
      <div class="info-line">
        <p><strong>Current:</strong> <span id="sensor-current-val">--</span></p>
        <p><strong>Last Updated:</strong> <span id="sensor-last-updated">--</span></p>
      </div>
      <div class="chart-wrapper">
        <canvas id="sensor-chart" style="height: 400px; width: 100%;"></canvas>
      </div>
    </div>
  `;

  const ctx = document.getElementById("sensor-chart")?.getContext("2d");

  if (!ctx) {
    console.error("‚ùå Chart canvas context not found");
    return;
  }

  // Initialize chart
  if (chart) chart.destroy(); // destroy old chart before re-creating

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Sensor Reading",
        data: [],
        borderColor: "#3498db",
        borderWidth: 2,
        fill: false,
        tension: 0.3,
        pointRadius: 3
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: "Time" }
        },
        y: {
          beginAtZero: true
        }
      }
    }
  });

  // Render the latest data after chart is ready
  displaySensorData(sensorKey);
}
    function displaySensorData(sensorKey) {
  const dataList = sensorReadingsLive[sensorKey] || [];

  const labels = dataList.map(d => d.reading_time);
  const values = dataList.map(d => d[sensorKey]);  // ‚úÖ FIX HERE

  const latest = dataList[dataList.length - 1];
  if (latest && latest[sensorKey] !== undefined) {
    document.getElementById("sensor-current-val").innerText = latest[sensorKey];
    document.getElementById("sensor-last-updated").innerText = new Date(latest.reading_time).toLocaleString();
  }

  if (chart) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
}


    function loadSettings() {
      document.getElementById("main-content").innerHTML = `
        <h2>Settings</h2>
        <div class="settings-container">
          <div class="card">
            <h3>Set Baud Rate</h3>
            <input type="text" placeholder="e.g. 9600"/>
          </div>
          <div class="card">
            <h3>Change Port</h3>
            <input type="text" placeholder="e.g. COM3 or /dev/ttyUSB0"/>
          </div>
        </div>
      `;
    }    

    function loadUserEngagementChart() {
      const container = document.getElementById("main-content");
      container.innerHTML = `
        <h2>User Engagement</h2>
        <canvas id="engagementChart" height="100"></canvas>
      `;

      const cityNames = Object.keys(data);
      const readingsPerCity = cityNames.map(city =>
        Object.values(data[city]).reduce((sum, sensor) => sum + sensor.readings.length, 0)
      );

      new Chart(document.getElementById("engagementChart"), {
        type: 'bar',
        data: {
           labels: cityNames,
           datasets: [{
            label: 'Readings Collected',
            data: readingsPerCity,
            backgroundColor: '#1abc9c'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Readings Collected Per City' }
          }
        }
      });
    }

    function loadDemographicOverviewChart() {
  const container = document.getElementById("main-content");
  container.innerHTML = `
    <h2>Demographic Overview</h2>
    <div style="width: 100%; max-width: 500px; margin: 0 auto;">
      <canvas id="statusChart" style="height: 300px;"></canvas>
    </div>
  `;

  const cities = Object.keys(data);
  const sensorCounts = cities.map(city => Object.keys(data[city]).length);

  new Chart(document.getElementById("statusChart"), {
    type: 'pie',
    data: {
      labels: cities,
      datasets: [{
        label: 'Sensor Count per City',
        data: sensorCounts,
        backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: 'Number of Sensors per City'
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}
        window.onload = loadHome;
  </script>
</body>
</html> 

